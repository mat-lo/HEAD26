<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LMStudio One-shot Chat</title>
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;s}
      .container{max-width:900px;margin:28px auto;padding:18px;border:1px solid #eee;border-radius:8px}
      label{display:block;margin:12px 0 6px;font-weight:600}
      input[type=text],textarea,select{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px}
      textarea{min-height:120px}
      .row{display:flex;gap:12px;align-items:center}
      .thumbs{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
      .thumb{width:96px;height:96px;object-fit:cover;border:1px solid #ccc;border-radius:6px}
      button{background:#0366d6;color:#fff;border:0;padding:10px 14px;border-radius:6px;cursor:pointer}
      pre{background:#0f1720;color:#e6eef8;padding:12px;border-radius:6px;overflow:auto}
      .meta{margin-top:12px;font-size:13px;color:#444}
    </style>
  </head>
  <body>
    <div class="container">
      <h2>LMStudio One-shot Chat</h2>

      <!-- Authentication disabled: API token removed -->

      <label for="model">Model</label>
      <input id="model" type="text" value="qwen/qwen3-vl-4b" />

      <label for="apiBase">API Base URL</label>
      <input id="apiBase" type="text" value="http://localhost:1234" />

      <label for="prompt">Message</label>
      <textarea id="prompt" placeholder="Ask the model something..."></textarea>

      <label for="images">Attach images (optional)</label>
      <input id="images" type="file" accept="image/*" multiple />
      <div id="previews" class="thumbs" aria-hidden="false"></div>

      <div style="margin-top: 14px" class="row">
        <button id="send">Send</button>
        <div style="flex: 1"></div>
      </div>

      <div class="meta" id="status"></div>

      <h3>Response</h3>
      <div id="response"></div>
    </div>

    <script>
      const modelEl = document.getElementById("model");
      const apiBaseEl = document.getElementById("apiBase");
      const promptEl = document.getElementById("prompt");
      const imagesEl = document.getElementById("images");
      const previewsEl = document.getElementById("previews");
      const sendBtn = document.getElementById("send");
      const responseEl = document.getElementById("response");
      const statusEl = document.getElementById("status");

      let imageDataUrls = [];

      imagesEl.addEventListener("change", async (e) => {
        previewsEl.innerHTML = "";
        imageDataUrls = [];
        const files = Array.from(e.target.files || []);
        for (const f of files) {
          if (!f.type.startsWith("image/")) continue;
          const dataUrl = await readFileAsDataURL(f);
          imageDataUrls.push(dataUrl);
          const img = document.createElement("img");
          img.src = dataUrl;
          img.className = "thumb";
          previewsEl.appendChild(img);
        }
      });

      function readFileAsDataURL(file) {
        return new Promise((res, rej) => {
          const fr = new FileReader();
          fr.onload = () => res(fr.result);
          fr.onerror = rej;
          fr.readAsDataURL(file);
        });
      }

      sendBtn.addEventListener("click", async () => {
        responseEl.innerHTML = "";
        statusEl.textContent = "";

        // No authentication required; the server accepts unauthenticated requests.
        const base = (apiBaseEl.value || "").trim().replace(/\/+$/, "");
        if (!base) {
          statusEl.textContent =
            "Please provide API base URL (eg. http://localhost:1234).";
          return;
        }

        const model = modelEl.value.trim();
        const prompt = promptEl.value.trim();
        if (!model || (!prompt && imageDataUrls.length === 0)) {
          statusEl.textContent = "Enter message text or attach an image.";
          return;
        }

        // Build input: text first (if provided), then any images
        const input = [];
        if (prompt) input.push({ type: "text", content: prompt });
        for (const d of imageDataUrls) {
          input.push({ type: "image", data_url: d });
        }

        const body = { model, input, stream: false };

        statusEl.textContent = "Sending request...";

        try {
          const url = base + "/api/v1/chat";
          const start = performance.now();
          const res = await fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(body),
          });

          if (!res.ok) {
            const txt = await res.text();
            statusEl.textContent =
              "Error: " + res.status + " " + res.statusText;
            responseEl.innerHTML = "<pre>" + escapeHtml(txt) + "</pre>";
            return;
          }

          const data = await res.json();
          const elapsedMs = performance.now() - start;
          statusEl.textContent = `Response received in ${Math.round(elapsedMs)} ms`;
          renderResponse(data, elapsedMs);
        } catch (err) {
          statusEl.textContent = "Request failed: " + err.message;
        }
      });

      function renderResponse(data, elapsedMs) {
        responseEl.innerHTML = "";
        const meta = document.createElement("div");
        meta.innerHTML =
          "<strong>Model instance:</strong> " +
          (data.model_instance_id || "—") +
          "<br/>" +
          "<strong>Response id:</strong> " +
          (data.response_id || "—") +
          (typeof elapsedMs === "number"
            ? "<br/><strong>Response time:</strong> " +
              Math.round(elapsedMs) +
              " ms"
            : "");
        responseEl.appendChild(meta);

        if (Array.isArray(data.output)) {
          for (const item of data.output) {
            const wrap = document.createElement("div");
            wrap.style.marginTop = "10px";
            if (item.type === "message") {
              const p = document.createElement("div");
              p.textContent = item.content || "";
              p.style.whiteSpace = "pre-wrap";
              p.style.padding = "8px";
              p.style.border = "1px solid #eee";
              p.style.borderRadius = "6px";
              wrap.appendChild(p);
            } else {
              const pre = document.createElement("pre");
              pre.textContent = JSON.stringify(item, null, 2);
              wrap.appendChild(pre);
            }
            responseEl.appendChild(wrap);
          }
        } else {
          responseEl.appendChild(document.createElement("pre")).textContent =
            JSON.stringify(data, null, 2);
        }

        if (data.stats) {
          const s = document.createElement("pre");
          s.style.marginTop = "12px";
          s.textContent = "Stats:\n" + JSON.stringify(data.stats, null, 2);
          responseEl.appendChild(s);
        }
      }

      function escapeHtml(str) {
        return String(str).replace(
          /[&<>\"]+/g,
          (s) =>
            ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" })[s] || s,
        );
      }
    </script>
  </body>
</html>
